# Overview

This repository contains the analysis scripts for the manuscript Mutation ages and population origins inferred from genomes in structured populations by Anna A. Nagel and Bruce Rannala. 
The simulations were run on the UC Davis Farm cluster HPC using the job scheduling system SLURM. 

# Required software
- bcftools (https://github.com/samtools/bcftools commit  d25e3f1)
- samtools (version 1.19)
- tsinfer/tsdate (Version: 0.4.1, 0.2.2, respectively)
- relate (https://github.com/MyersGroup/relate commit 9b1715b46e)
- argweaver (there doesn't appear to be any version listed) 
- bpp (see below)
- MutAnce
- vcftools (0.1.16)
- R
- msprime (version 1.3.3)

Some of the paths in the scripts may need to be adjusted depending on how the software is installed.

## Compiling bpp
The manuscript uses an older version of bpp. 
The parametrization of migration has changed, as have some of the control file options. 
To use the older version, 

```
git clone https://github.com/bpp/bpp.git
cd bpp
git checkout devAnna
cd src
make
```
You must have a C compiler, such as gcc or clang, installed to compile the program. 
To use the make command, you must have the make system installed.
Then bpp should be added to the path. 

# Directories
- dnaSim:  Contains C files and a Makefile for a program to simulate DNA sequences given an input tree and substitution model parameters. 
This is used to simulate sequence data using an HKY model for trees from an ancestral recombination graph generated by msprime. 
This is not used for the simulations without recombination.

- empirical:  This contains the analysis scripts for the empirical dataset (Figure 7). Not included are the vcf files from the 1000 Genomes project or the genome annotations.
They can be downloaded from <https://www.internationalgenome.org/data-portal/data-collection/30x-grch38> and <https://www.ncbi.nlm.nih.gov/refseq/annotation_euk/Homo_sapiens/GCF_000001405.40-RS_2023_10/>. 

- simulations: This contains the analysis scripts for all simulation results, including the correctness of the posterior probabilities (Figure 2, test_PP directory), the impact of locus length (Figure 3 and 4, locusLength directory), the impact of the number of samples (Figure 3 and 5, numSamples directory), and the impact of recombination (Figure 6, recombination directory).


# To reproduce the results: 
To clone the program from GitHub 

```
git clone https://github.com/nage0178/mutInference_analysis.git
cd mutInference_analysis
```

## Compile the DNA simulation program
To compile the program to generate sequence data for the recombination analysis, navigate to the directory and use the make command.

```
cd dnaSim/
make
```
You must have a C compiler, such as gcc or clang, installed to compile the program. 
To use the make command, you must have the make system installed.
Then the program should be added to the path.

## Empirical analysis
To run the empirical analysis, move into the empirical directory.
```
cd ../empirical
```

The following script draws individuals to be included in the analysis from the three populations.

```
./findAsEuAfrNames.sh
```

This script selects genomic regions to use as loci for the bpp analysis. This also does some vcf file processing. 
```
./chooseRegions.sh
```

This script creates the alignments for each locus and combines them in a format for bpp. 
```
./prep_align.sh
```

The script to prepare the bpp control files is in the bpp directory. 
This changes the seeds in the control files and sets the file names in the control files.
Then run bpp. Each run is threaded and will take many weeks to run.
```
cd bpp
./prepSatMcmc.sh
./runMCMC.sh
```

After bpp finishes, run MutAnce. This should be substantially faster than running bpp.
```
./runMutAnce.sh
```

The process results of the MCMCs into tables to plot in R
```
cd sat_1_l1000
./processResults.sh
cd ../sat_1_l5000
./processResults.sh
cd ../sat_1_l10000
./processResults.sh
cd ../
```

## Test of correctness of posterior probabilities
To reproduce the simulation analyses, starting with the tests of correctness of the posterior probabilities, move into the correct directory.
```
cd ../../simulations/test_PP/
```
Create the simulation and inference files for the 5 sets of simulation conditions. 
For each of the 5 sets of conditions, there will be 50 datasets, each with two replicate MCMCs.

```
cd tree1/migHigh
../../prepMCMC.sh
cd ../migLow
../../prepMCMC.sh
cd ../../tree2/migHigh
../../prepMCMC.sh
cd ../migLow
../../prepMCMC.sh
cd ../migVHigh
../../prepMCMC.sh
cd ../../
```

Then, the MCMCs are ready to be run. 
The analysis was run using slurm. 
Each set of the 5 sets analyses has two slurm scripts, one for the first and second replicate MCMCs (slurm.sh and slurm2.sh).
After navigating to the directory, there is one line that simulates the dataset and a second that runs the MCMCs in bpp. 
```
../../../bpp --simulate simulate.ctl &> simOut
../../../bpp --cfile inference.ctl  &> infOut &
```

After the MCMCs finish, the check convergence scripts flags MCMC pairs that should be check manually. 
The ones printed to screen should be checked.
This appears to be conservative, reporting many MCMCs that seem to have converged as assessed by comparing the trace plots for the two runs and the ESS values.
```
cd tree1/migLow
../checkConvergence.sh
Rscript ../checkConvergence.R
cd ../migHigh
../checkConvergence.sh
Rscript ../checkConvergence.R
cd ../../tree2/migLow
../checkConvergence.sh
Rscript ../checkConvergence.R
cd ../migHigh
../checkConvergence.sh
Rscript ../checkConvergence.R
cd ../migVHigh
../checkConvergence.sh
Rscript ../checkConvergence.R
cd ../../
```

Then, the output files of the MCMC are subsampled. This is to decrease the run time. 
```
cd tree1/migLow/ 
../../inferMut.sh
cd ../migHigh/ 
../../inferMut.sh
cd ../../tree2/migHigh/ 
../../inferMut.sh
cd ../migVHigh/ 
../../inferMut.sh
cd ../migLow/ 
../../inferMut.sh
cd ../../
```

Finally, MutAnce is run on all of the loci. 
As with the MCMCs, this was accomplished using SLURM with the scripts named slurm\_Mut.sh.
The slurm script navigates to each of the directories and then runs the following command. 
```
../../../MutAnce ${locus}.ctl &> 2out${locus}
```

The following command combine the results of the analyses into tables. 
One dataset is skipped in the migVHigh simulations because it did not converge. 
```
cd tree1/migLow/ 
../parseSim.sh
cd ../migHigh/ 
../parseSim.sh
cd ../../tree2/migHigh/ 
../parseSim.sh
cd ../migLow/ 
../parseSim.sh
cd ../migVHigh/ 
./inferMut.sh
cd ../../
```

## Locus length simulations
This section runs the analyses that investigate the impact of locus length on the method performance.
First, navigate to the locusLength directory in the simulations directory 
```
cd ../locusLength
```

This command prepares for inference by simulating sequence data and determining which site will be the focal SNP for each focal locus. It also creates the control files and directory systems.

```
./prepSim.sh
```

Then, the analyses can be run. Again, a slurm script was originally used (slurm_MCMC.sh). 
After navigating to each directory, the slurm script runs the command  
```
bpp --cfile inference.ctl --theta_mode 3 &> output &
```

To check convergence, run the following. Any analyses printed to screen should be manually inspected in tracer.
```
./checkConvergence.sh
Rscript checkCovergence.R
```

To prepare the control files to run MutAnce, run the following
```
./prepMutInf.sh
```

MutAnce was run using slurm using the script slurm_MutInf.sh. This script runs MutAnce once for each focal locus for each replicate simulation.

The analyses with known gene trees were prepared with the following command. This takes the true gene trees, migration histories (which include population divergence times), and HKY model parameters and creates files in the correct format for MutAnce.
```
./prepGtree.sh
```
The analyses were run with the slurm script slurm_MutFixed.sh.

Once the analyses were done, tables were created that were used to create figures with the following scripts commands.
```
./parseSim.sh
./parseFixed.sh
```

## Sample size simulations
To reproduce the sample size simulations, navigate to the numSamples directory within the simulation directory.
```
cd ../numSamples
```

Prepare the input files. This simulates the sequence data and ensures that the mutation is at intermediate frequency. It also subsamples the large sample for the different datasets.
```
./prepSim.sh
```

Then run bpp. This was originally run with slurm using a script (slurm_MCMC.sh). The relevant line to run in each analysis directory is 
```
bpp --cfile inference.ctl --theta_mode 3 &> output &
```

Then convergence can be assessed with the following commands
```
./checkConvergence.sh
Rscript checkConvergence.R
```
Any analyses that are printed to screen should be manually inspected with tracer.

Next, MutAnce is run. Again, this was originally run with a slurm script (slurm_MutInf.sh).
The output is parsed into tables used in R with the following.
```
./parseSim.sh
```

## Recombination simulations
The directory has the files to simulate ARGs, simulate sequence data given the trees from the ARGs, and run analyses with bpp/MutAnce, tsinfer/tsdate, relate, and ARGWeaver. 

### Simulating the data
Move into the recombination directory. 
```
cd ../recombination
```

Simulate the ARG with msprime. This was done with a slurm script (slurm_prep.sh), which calls prepLocus.sh. A virtual environment named sim was used for msprime.
After the ARGs are simulated, simulate the sequence data. There are many slurm scripts (slurm_prepDna\*.sh) for this since there is one job per locus, which is greater than the array size limit on the HPC.

### MutAnce analyses 

This shortens the alignments for the focal loci to 5000 base pairs and creates the sequence files for bpp. Longer sequences were simulated for use in the other programs, which may benefit from longer sequences as they model recombination.
Then it creates control files for every bpp run.
```
./prepBPP.sh
./prepCtl.sh
```

Then run bpp. This was done with a slurm script (slurm_MCMC.sh).
After the bpp runs are done, convergence should be check with the following
```
./checkConvergence.sh
Rscript checkConvergence.R
```
The runs that are printed to screen were inspected manually. 
The ones that did not converge are listed in rmMutAnceDir.  

Then prepare the input files for MutAnce. 
```
./prepMutInf.sh
```

MutAnce was run using the slurm script (slurm_MutInf.sh).

The output was parsed into table using
```
./parseSim.sh
```
### Other files

This creates a vcf file to be used for the programs that require vcf files. It is run by slurm_vcf.sh
```
./prepVCF.sh
```
The slurm script, slurm_findN.sh,  estimates N for every focal locus. N is required as an argument for some of the programs.

### tsinfer/tsdate analyses
The tsdate analyses are run with slurm_tsdate.sh. A virtual environment named tsInferDate was used for tsinfer and tsdate.
The output is summarized with the following.
```
./processTsdate_bugfix.sh
```

### relate analyses

Slurm script slurm_relate.sh run the relate analyses. 

Then output is processes into a table with the following script using the following command.
```
cd relate
./processRelate.sh
cd ../
```

### ARGWeaver analyses
These slurm script run the ARGWeaver analyses (slurm_argweaver.sh, slurm_argweaver2.sh) for the first and second replicates.
The mutation ages are estimated with the slurm script slurm_argMut.sh.
Then the results are unzipped with slurm_argUngz.sh

The following command is used to  compute some statistics in R including the mean and credible intervals, which are used to summarize the results.
```
./processArg.sh
```

### Checking outputs
The matching of the simulations to the inferences was checked by confirming the same bases were present at the each focal site for relate, tsdate, and ARGweaver. 
These scripts are called check_processArg.sh, check_processTsdate.sh, and relate/check_process.sh
